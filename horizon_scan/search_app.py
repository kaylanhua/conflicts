import streamlit as st
from pyvis.network import Network
import networkx as nx
import json
import streamlit.components.v1 as components

st.set_page_config(layout="wide")

def set_bg_color(hex_color):
    st.markdown(
        f"""
        <style>
        .stApp {{
            background: {hex_color};
        }}
        div.stButton > button:first-child {{
            margin-top: 1.5em;
            height: 2.6em;   
        }}
        </style>
        """,
        unsafe_allow_html=True
    )

set_bg_color('#F9F5F1')



# Read the JSON data from file
# filename = '/mount/src/conflicts/horizon_scan/rf_jsons/rf24.json' ## on server
filename = './rf_jsons/rf24.json' ## on local
with open(filename, 'r') as file:
    papers = json.load(file)

len(papers)



# Function to generate and display the network
## consider caching with st.cache to make this faster
def generate_network(search_keyword=None):
    # st.spinner('searching the network...')
    G = nx.Graph()  # or however you construct your graph
    # Nodes
    for id, info in papers.items():
        G.add_node(id, **info[0])

    # Edges
    for id, info in papers.items():
        for cited_id in info[1]:
            if G.has_node(cited_id):
                G.add_edge(id, cited_id)

    # Assuming 'G' is your NetworkX graph
    net = Network(notebook=False, height="750px", width="100%", bgcolor="#F9F5F1", font_color="black")

    ## searching for keywords and adding nodes
    for node, node_attrs in G.nodes(data=True):
        color = '#5C4033' if search_keyword and search_keyword.lower() in node_attrs['abstract'].lower() else '#C8A482'
        net.add_node(node, label=node_attrs['title'], title=node_attrs['abstract'], color=color)

    for edge in G.edges():
        net.add_edge(edge[0], edge[1], arrows='to')

    # Customize the visualization as needed
    net.repulsion(node_distance=420, central_gravity=0.33,
                spring_length=110, spring_strength=0.10,
                damping=0.95)

    # Save and show the graph as an HTML file
    net.show('str_graph.html', notebook=False)

    # Load and display the graph
    with open('str_graph.html', 'r', encoding='utf-8') as html_file:
        source_code = html_file.read()
        components.html(source_code, height=750)


# ----------------------------------------------

# Title and introduction
st.title("[wip] kayla's network analysis")
st.write('an exploration of machine learning and conflict modeling (disclaimer: loading the network takes a few seconds. please be patient!)')

# Keyword search functionality
col1, col2 = st.columns([3, 1]) 

with col1:
    search_keyword = st.text_input("search for mentions of keywords (e.g., 'random forest' or 'Syria') in paper abstracts:")
with col2:
    # Button to generate the network
    search_button = st.button('search network', key='search')

if search_button:
    generate_network(search_keyword)


st.markdown("---")
st.markdown('**the resulting literature review, as generated by chatgpt:**')

st.write("""
         In the literature concerning the use of tree-based algorithms for modeling armed civil conflicts, the evolution of methodologies and their effectiveness in various contexts have been extensively studied. This review synthesizes the findings and methodologies utilized across several research papers spanning from 2008 to 2022.

The earliest work by Weidmann (2008) laid the groundwork for employing machine learning in the prediction of conflict. By using ensemble classifiers and focusing on decision tree learning, attention was drawn to addressing the issue of rare events in conflict data - a recurring theme in subsequent studies. 

Siroky (2009) pursued a more in-depth exploration of Random Forests, tracing its intellectual history and providing an understanding of its non-parametric nature. This marks an early indication of a move away from traditional logistic regression models, which aligns with the findings of Muchlinski (2016) that randomized forests outperform logistic regression in predicting civil war onsets.

As methods advanced, the literature indicated an emerging preference for algorithmic approaches over classical statistical methods due to their superior predictive capabilities. Jones (2016) introduced 'edarf', elucidating how Random Forests can be applied in exploratory data analysis to detect complex interactions in conflict data.

Freiman (2010) incorporated Simulated Annealing alongside Random Forests to refine parameter selection in predictive models. This study emphasizes the potential pitfalls of overfitting, suggesting a need for careful model evaluation.

The role of Random Forests in conflict prediction continued to expand, as indicated by the study of Ettensperger (2021), which further corroborated the utility of multi-model ensemble methods. The shift towards ensembles suggests that combining various tree-based models can harness different strengths and potentially lead to improved predictions.

Gradient boosting entered the conversation with the work of Vestby (2022), indicating that while Random Forests might be superior in terms of mean square error, Gradient Boosting might be more effective in specific predictive scenarios. This highlights the evolution of tree-based methodologies and the importance of context and performance metrics in evaluating these models.

Further refining the predictive capabilities, Metternich (2019) presented an actor-centric view focusing on the characteristics of rebel organizations, emphasizing the role of actors in predicting conflict severity through Random Forests.

Alongside these advancements, significant contributions were made to address technical challenges. Darbon (2021) proposed an efficient algorithm to handle high-dimensional sparse logistic regression, hinting at the growing importance of computational efficiency in large-scale conflict data analysis.

Parallel to the methodological advances, scholars such as Schellens (2020) and Henrickson (2020) have been employing these tree-based algorithms to uncover underlying patterns in conflict data, ranging from the role of natural resources in violent conflicts to the computation of expected war costs.

Several studies (e.g., Montgomery, 2018; Musumba, 2021) underscore the applicability of machine learning and tree-based models beyond predictions, also using them to ascertain the relative importance of features and improve our theoretical understanding of conflicts. 

In conclusion, tree-based algorithms have significantly evolved and increasingly demonstrated their suitability for modeling complex phenomena such as armed civil conflicts over the last decades. From addressing the rarity of certain events to leveraging ensemble methods for refined predictions, these algorithms have been confirmed to be powerful tools for conflict analysis. Their flexibility and capability to capture non-linear interactions make them superior to traditional regression methods in many scenarios. This evolution has led to a more nuanced and sophisticated understanding of the factors driving armed conflict, permitting researchers to make increasingly accurate predictions, and allowing policymakers to respond more effectively to the threat of civil war.
""")